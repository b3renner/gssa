<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cadastrar ONG - GSSA</title>
    <link rel="icon" href="gssa_logo_transp.png">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="style.css">
    <style>
        .cadastro-ong-container {
            max-width: 800px;
            margin: 40px auto;
            padding: 20px;
        }

        .page-header {
            text-align: center;
            margin-bottom: 40px;
            padding-bottom: 20px;
            border-bottom: 3px solid var(--color-highlight);
        }

        .page-header h1 {
            color: var(--color-highlight);
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .alert-box {
            background: rgba(217, 83, 79, 0.1);
            border-left: 4px solid var(--color-highlight);
            padding: 15px 20px;
            margin-bottom: 30px;
            border-radius: 6px;
        }

        .alert-box h3 {
            color: var(--color-highlight);
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .form-section {
            background: var(--bg-secondary);
            padding: 25px;
            border-radius: 12px;
            margin-bottom: 20px;
            box-shadow: 0 4px 8px var(--color-shadow);
        }

        .form-section h2 {
            color: var(--color-tint);
            margin-bottom: 20px;
            font-size: 1.5em;
            border-bottom: 2px solid var(--bg-map-border);
            padding-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 15px;
        }

        .help-text {
            font-size: 0.85em;
            color: var(--text-secondary);
            margin-top: 5px;
            font-style: italic;
        }

        .file-upload input[type="file"] {
            display: none;
        }

        .file-upload-label {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            padding: 15px;
            background: var(--bg-primary);
            border: 2px dashed var(--bg-map-border);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            color: var(--text-secondary);
        }

        .file-upload-label:hover {
            border-color: var(--color-highlight);
            background: rgba(217, 83, 79, 0.05);
        }

        .file-upload-label.has-file {
            border-color: var(--color-success);
            border-style: solid;
            background: rgba(76, 175, 80, 0.05);
        }

        .file-name {
            font-size: 0.9em;
            color: var(--color-success);
            margin-top: 8px;
            display: none;
            align-items: center;
            gap: 5px;
        }

        .file-name.show {
            display: flex;
        }

        .terms-checkbox {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            margin: 20px 0;
            padding: 15px;
            background: var(--bg-primary);
            border-radius: 8px;
        }

        .terms-checkbox input[type="checkbox"] {
            margin-top: 3px;
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .terms-checkbox label {
            cursor: pointer;
            font-size: 0.95em;
        }

        .submit-section {
            text-align: center;
            margin-top: 30px;
        }

        .submit-button-large {
            padding: 15px 40px;
            font-size: 1.2em;
            background: linear-gradient(135deg, var(--color-highlight), var(--color-tint));
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: transform 0.2s, box-shadow 0.3s;
            box-shadow: 0 4px 12px var(--color-shadow);
        }

        .submit-button-large:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px var(--color-shadow);
        }

        .submit-button-large:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .progress-indicator {
            display: none;
            text-align: center;
            padding: 20px;
            background: var(--bg-secondary);
            border-radius: 8px;
            margin-top: 20px;
        }

        .progress-indicator.show {
            display: block;
        }

        .progress-steps {
            margin-top: 15px;
            color: var(--text-secondary);
        }

        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
            }

            .page-header h1 {
                font-size: 2em;
            }

            .cadastro-ong-container {
                padding: 10px;
            }
        }
    </style>
</head>
<body>
    <header class="main-header">
        <div class="header-left">
            <img src="gssa_logo.png" alt="Logo GSSA" class="gssa-logo-img">
            <div class="logo-titles">
                <h1 class="logo-main-title">GSSA</h1>
                <p class="logo-subtitle">Gravata√≠ Support & Shelter Assist</p>
            </div>
        </div>
        <nav class="header-right">
            <a href="index.html" class="nav-button">Voltar ao In√≠cio</a>
            <button id="theme-toggle" class="toggle-button" aria-label="Alternar Tema">
                <i class="fas fa-sun"></i>
            </button>
        </nav>
    </header>

    <div class="cadastro-ong-container">
        <div class="page-header">
            <h1><i class="fas fa-hands-helping"></i> Cadastrar ONG</h1>
            <p>Junte-se √† rede de organiza√ß√µes parceiras do GSSA</p>
        </div>

        <div class="alert-box">
            <h3><i class="fas fa-info-circle"></i> Informa√ß√µes Importantes</h3>
            <ul style="margin-left: 25px;">
                <li>CNPJ da organiza√ß√£o (obrigat√≥rio)</li>
                <li>Comprovante de registro (PDF, JPG ou PNG - m√°x. 2MB)</li>
                <li>E-mail institucional da ONG</li>
                <li style="font-weight: bold; margin-top: 10px;">‚ö†Ô∏è Seu cadastro ser√° analisado manualmente antes da aprova√ß√£o.</li>
            </ul>
        </div>

        <form id="cadastro-ong-form">
            <!-- SE√á√ÉO 1: Informa√ß√µes B√°sicas -->
            <div class="form-section">
                <h2><i class="fas fa-building"></i> Informa√ß√µes da Organiza√ß√£o</h2>
                
                <div class="form-group">
                    <label for="ong-name">Nome Completo da ONG *</label>
                    <input type="text" id="ong-name" required placeholder="Ex: Funda√ß√£o Casa dos Sonhos">
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="ong-cnpj">CNPJ *</label>
                        <input type="text" id="ong-cnpj" required placeholder="00.000.000/0000-00" maxlength="18">
                        <span class="help-text">Formato: XX.XXX.XXX/XXXX-XX</span>
                    </div>
                    <div class="form-group">
                        <label for="ong-phone">Telefone *</label>
                        <input type="tel" id="ong-phone" required placeholder="(51) 99999-9999">
                    </div>
                </div>

                <div class="form-group">
                    <label for="ong-email">E-mail Institucional *</label>
                    <input type="email" id="ong-email" required placeholder="contato@ong.org.br">
                    <span class="help-text">Prefer√≠vel usar e-mail oficial da ONG</span>
                </div>

                <div class="form-group">
                    <label for="ong-website">Website (Opcional)</label>
                    <input type="url" id="ong-website" placeholder="https://www.suaong.org.br">
                </div>
            </div>

            <!-- SE√á√ÉO 2: Endere√ßo -->
            <div class="form-section">
                <h2><i class="fas fa-map-marker-alt"></i> Localiza√ß√£o</h2>
                
                <div class="form-group">
                    <label for="ong-address">Endere√ßo Completo *</label>
                    <input type="text" id="ong-address" required placeholder="Rua, N√∫mero, Complemento">
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="ong-neighborhood">Bairro *</label>
                        <input type="text" id="ong-neighborhood" required placeholder="Ex: Centro">
                    </div>
                    <div class="form-group">
                        <label for="ong-zip">CEP *</label>
                        <input type="text" id="ong-zip" required placeholder="00000-000" maxlength="9">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="ong-lat">Latitude *</label>
                        <input type="text" id="ong-lat" required placeholder="-29.9402" step="any">
                        <span class="help-text">
                            <a href="https://www.google.com/maps" target="_blank" style="color: var(--color-highlight);">
                                <i class="fas fa-map-marker-alt"></i> Buscar no Google Maps
                            </a>
                        </span>
                    </div>
                    <div class="form-group">
                        <label for="ong-lon">Longitude *</label>
                        <input type="text" id="ong-lon" required placeholder="-50.9944" step="any">
                        <span class="help-text">Clique com bot√£o direito no mapa ‚Üí "O que h√° aqui?"</span>
                    </div>
                </div>
            </div>

            <!-- SE√á√ÉO 3: Sobre a ONG -->
            <div class="form-section">
                <h2><i class="fas fa-heart"></i> Sobre a Organiza√ß√£o</h2>
                
                <div class="form-group">
                    <label for="ong-description">Descri√ß√£o da ONG *</label>
                    <textarea id="ong-description" rows="4" required placeholder="Descreva brevemente a miss√£o e atividades da organiza√ß√£o (m√≠nimo 100 caracteres)..."></textarea>
                    <span class="help-text" id="char-count">0 / 100 caracteres</span>
                </div>

                <div class="form-group">
                    <label for="ong-services">Servi√ßos Oferecidos *</label>
                    <input type="text" id="ong-services" required placeholder="Ex: Alimenta√ß√£o, Roupa, Abrigo, Suporte Psicossocial">
                    <span class="help-text">Separe por v√≠rgulas</span>
                </div>

                <div class="form-group">
                    <label for="ong-target">P√∫blico Alvo *</label>
                    <input type="text" id="ong-target" required placeholder="Ex: Popula√ß√£o em situa√ß√£o vulner√°vel">
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="ong-capacity">Capacidade de Atendimento (pessoas/dia)</label>
                        <input type="number" id="ong-capacity" placeholder="Ex: 50" min="1">
                    </div>
                    <div class="form-group">
                        <label for="ong-schedule">Hor√°rio de Funcionamento *</label>
                        <input type="text" id="ong-schedule" required placeholder="Ex: Seg-Sex, 8h-18h">
                    </div>
                </div>
            </div>

            <!-- SE√á√ÉO 4: Documenta√ß√£o -->
            <div class="form-section">
                <h2><i class="fas fa-file-upload"></i> Documenta√ß√£o</h2>
                
                <div class="form-group">
                    <label>Comprovante de CNPJ *</label>
                    <div class="file-upload">
                        <input type="file" id="cnpj-document" accept="image/*,.pdf" required>
                        <label for="cnpj-document" class="file-upload-label" id="cnpj-label">
                            <i class="fas fa-cloud-upload-alt"></i>
                            <span>Clique para selecionar arquivo</span>
                        </label>
                        <div class="file-name" id="cnpj-filename"></div>
                    </div>
                    <span class="help-text">Formatos aceitos: PDF, JPG, PNG (m√°x. 2MB)</span>
                </div>
            </div>

            <!-- SE√á√ÉO 5: Respons√°vel -->
            <div class="form-section">
                <h2><i class="fas fa-user-tie"></i> Dados do Respons√°vel</h2>
                
                <div class="form-group">
                    <label for="admin-name">Nome Completo do Respons√°vel *</label>
                    <input type="text" id="admin-name" required placeholder="Nome completo">
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="admin-role">Cargo na Organiza√ß√£o *</label>
                        <input type="text" id="admin-role" required placeholder="Ex: Diretor, Coordenador">
                    </div>
                    <div class="form-group">
                        <label for="admin-phone">Telefone do Respons√°vel *</label>
                        <input type="tel" id="admin-phone" required placeholder="(51) 99999-9999">
                    </div>
                </div>

                <div class="form-group">
                    <label for="admin-email">E-mail do Respons√°vel (Login) *</label>
                    <input type="email" id="admin-email" required placeholder="seu@email.com">
                    <span class="help-text">Este ser√° o e-mail de login para acessar o painel administrativo</span>
                </div>

                <div class="form-group">
                    <label for="admin-password">Senha de Acesso *</label>
                    <input type="password" id="admin-password" required placeholder="M√≠nimo 6 caracteres" minlength="6">
                </div>

                <div class="form-group">
                    <label for="admin-password-confirm">Confirme a Senha *</label>
                    <input type="password" id="admin-password-confirm" required placeholder="Digite a senha novamente">
                </div>
            </div>

            <!-- Termos -->
            <div class="terms-checkbox">
                <input type="checkbox" id="terms-checkbox" required>
                <label for="terms-checkbox">
                    Declaro que as informa√ß√µes fornecidas s√£o verdadeiras e estou ciente de que o cadastro ser√° analisado pela equipe do GSSA antes da aprova√ß√£o. 
                    Concordo em receber volunt√°rios atrav√©s da plataforma e comprometo-me a gerenciar as inscri√ß√µes de forma respons√°vel.
                </label>
            </div>

            <!-- Bot√£o de Envio -->
            <div class="submit-section">
                <button type="submit" class="submit-button-large" id="submit-button">
                    <i class="fas fa-paper-plane"></i> Enviar Cadastro para An√°lise
                </button>
            </div>

            <!-- Indicador de Progresso -->
            <div class="progress-indicator" id="progress-indicator">
                <h3><i class="fas fa-spinner fa-spin"></i> Processando seu cadastro...</h3>
                <p class="progress-steps" id="progress-text">Iniciando...</p>
            </div>

            <!-- Mensagem de Resultado -->
            <div id="form-message" class="form-message"></div>
        </form>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDhQs9Kz4LLGaKIhWV9nUiTjlst5YEWhjg",
            authDomain: "gssa-gravatai.firebaseapp.com",
            projectId: "gssa-gravatai",
            storageBucket: "gssa-gravatai.firebasestorage.app",
            messagingSenderId: "650753472587",
            appId: "1:650753472587:web:65b706993648dc602975ce"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Elementos DOM
        const form = document.getElementById('cadastro-ong-form');
        const submitButton = document.getElementById('submit-button');
        const progressIndicator = document.getElementById('progress-indicator');
        const progressText = document.getElementById('progress-text');
        const formMessage = document.getElementById('form-message');
        const themeToggle = document.getElementById('theme-toggle');

        // Inicializar tema
        const savedTheme = localStorage.getItem('theme');
        if (savedTheme === 'dark') {
            document.body.classList.add('dark-mode');
            themeToggle.querySelector('i').classList.replace('fa-sun', 'fa-moon');
        }

        themeToggle.addEventListener('click', () => {
            document.body.classList.toggle('dark-mode');
            const isDark = document.body.classList.contains('dark-mode');
            const icon = themeToggle.querySelector('i');
            if (isDark) {
                icon.classList.replace('fa-sun', 'fa-moon');
                localStorage.setItem('theme', 'dark');
            } else {
                icon.classList.replace('fa-moon', 'fa-sun');
                localStorage.setItem('theme', 'light');
            }
        });

        // M√°scaras de input
        document.getElementById('ong-cnpj').addEventListener('input', (e) => {
            let value = e.target.value.replace(/\D/g, '');
            if (value.length <= 14) {
                value = value.replace(/^(\d{2})(\d)/, '$1.$2');
                value = value.replace(/^(\d{2})\.(\d{3})(\d)/, '$1.$2.$3');
                value = value.replace(/\.(\d{3})(\d)/, '.$1/$2');
                value = value.replace(/(\d{4})(\d)/, '$1-$2');
            }
            e.target.value = value;
        });

        document.getElementById('ong-zip').addEventListener('input', (e) => {
            let value = e.target.value.replace(/\D/g, '');
            if (value.length <= 8) {
                value = value.replace(/^(\d{5})(\d)/, '$1-$2');
            }
            e.target.value = value;
        });

        // Contador de caracteres
        document.getElementById('ong-description').addEventListener('input', (e) => {
            const count = e.target.value.length;
            document.getElementById('char-count').textContent = `${count} / 100 caracteres`;
        });

        // Preview de arquivo
        document.getElementById('cnpj-document').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                const label = document.getElementById('cnpj-label');
                const filename = document.getElementById('cnpj-filename');
                
                label.classList.add('has-file');
                label.innerHTML = '<i class="fas fa-check-circle"></i><span>Arquivo selecionado</span>';
                filename.classList.add('show');
                filename.innerHTML = `<i class="fas fa-file"></i> ${file.name} (${(file.size / 1024).toFixed(0)} KB)`;
            }
        });

        // Converter arquivo para Base64
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                // Validar tamanho (2MB)
                if (file.size > 2 * 1024 * 1024) {
                    reject(new Error('Arquivo muito grande. M√°ximo: 2MB'));
                    return;
                }

                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = () => reject(new Error('Erro ao ler arquivo'));
                reader.readAsDataURL(file);
            });
        }

        // Envio do formul√°rio
        form.addEventListener('submit', async (e) => {
            e.preventDefault();

            // Valida√ß√µes
            const password = document.getElementById('admin-password').value;
            const confirmPassword = document.getElementById('admin-password-confirm').value;

            if (password !== confirmPassword) {
                formMessage.className = 'form-message error';
                formMessage.innerHTML = '<i class="fas fa-times-circle"></i> As senhas n√£o coincidem.';
                return;
            }

            const description = document.getElementById('ong-description').value;
            if (description.length < 100) {
                formMessage.className = 'form-message error';
                formMessage.innerHTML = '<i class="fas fa-times-circle"></i> A descri√ß√£o deve ter no m√≠nimo 100 caracteres.';
                return;
            }

            // Desabilitar bot√£o e mostrar progresso
            submitButton.disabled = true;
            progressIndicator.classList.add('show');
            formMessage.innerHTML = '';

            try {
                // 1. Processar documento
                progressText.textContent = '1/5 - Processando documento...';
                const fileInput = document.getElementById('cnpj-document');
                let documentBase64 = null;

                if (fileInput.files.length > 0) {
                    documentBase64 = await fileToBase64(fileInput.files[0]);
                }

                // 2. Validar coordenadas
                progressText.textContent = '2/5 - Validando coordenadas...';
                const latValue = document.getElementById('ong-lat').value.trim();
                const lonValue = document.getElementById('ong-lon').value.trim();

                if (!latValue || !lonValue) {
                    throw new Error('Latitude e Longitude s√£o obrigat√≥rias');
                }

                const latitude = parseFloat(latValue);
                const longitude = parseFloat(lonValue);

                if (isNaN(latitude) || isNaN(longitude)) {
                    throw new Error('Latitude e Longitude devem ser n√∫meros v√°lidos');
                }

                if (latitude < -90 || latitude > 90) {
                    throw new Error('Latitude deve estar entre -90 e 90');
                }

                if (longitude < -180 || longitude > 180) {
                    throw new Error('Longitude deve estar entre -180 e 180');
                }

                console.log('‚úÖ Coordenadas validadas:', { lat: latitude, lon: longitude });

                // 3. Criar conta de usu√°rio
                progressText.textContent = '3/5 - Criando conta de acesso...';
                const adminEmail = document.getElementById('admin-email').value;
                const userCredential = await createUserWithEmailAndPassword(auth, adminEmail, password);
                const userId = userCredential.user.uid;
                console.log('‚úÖ Usu√°rio criado:', userId);

                // 4. Salvar dados do usu√°rio
                progressText.textContent = '4/5 - Salvando dados do respons√°vel...';
                await setDoc(doc(db, 'users', userId), {
                    name: document.getElementById('admin-name').value,
                    email: adminEmail,
                    role: 'ong',
                    createdAt: serverTimestamp()
                });
                console.log('‚úÖ Dados do usu√°rio salvos');

                // 5. Salvar dados da ONG
                progressText.textContent = '5/5 - Registrando organiza√ß√£o...';
                const ongData = {
                    adminUserId: userId,
                    basicInfo: {
                        name: document.getElementById('ong-name').value,
                        cnpj: document.getElementById('ong-cnpj').value,
                        email: document.getElementById('ong-email').value,
                        phone: document.getElementById('ong-phone').value,
                        website: document.getElementById('ong-website').value || null
                    },
                    address: {
                        street: document.getElementById('ong-address').value,
                        neighborhood: document.getElementById('ong-neighborhood').value,
                        zip: document.getElementById('ong-zip').value,
                        city: 'Gravata√≠',
                        state: 'RS'
                    },
                    coordinates: {
                        lat: latitude,
                        lon: longitude
                    },
                    description: description,
                    services: document.getElementById('ong-services').value,
                    targetAudience: document.getElementById('ong-target').value,
                    capacity: parseInt(document.getElementById('ong-capacity').value) || null,
                    schedule: document.getElementById('ong-schedule').value,
                    admin: {
                        name: document.getElementById('admin-name').value,
                        role: document.getElementById('admin-role').value,
                        phone: document.getElementById('admin-phone').value
                    },
                    documents: {
                        cnpjDocument: documentBase64
                    },
                    status: 'pending',
                    createdAt: serverTimestamp(),
                    updatedAt: serverTimestamp()
                };

                console.log('üìä Dados da ONG para salvar:', ongData);
                console.log('üìç Coordenadas:', ongData.coordinates);

                const ongRef = await addDoc(collection(db, 'ongs'), ongData);
                console.log('‚úÖ ONG registrada com ID:', ongRef.id);

                // 5. Criar notifica√ß√£o para super-admin
                await addDoc(collection(db, 'notifications'), {
                    type: 'new_ong_registration',
                    ongId: ongRef.id,
                    ongName: ongData.basicInfo.name,
                    ongEmail: ongData.basicInfo.email,
                    targetUser: 'super-admin',
                    read: false,
                    createdAt: serverTimestamp()
                });

                // Sucesso!
                progressIndicator.classList.remove('show');
                formMessage.className = 'form-message success';
                formMessage.innerHTML = `
                    <i class="fas fa-check-circle"></i>
                    <h3 style="margin: 10px 0;">Cadastro enviado com sucesso!</h3>
                    <p>Sua ONG ser√° analisada em breve. Voc√™ receber√° uma notifica√ß√£o quando for aprovada.</p>
                    <p style="margin-top: 10px; font-size: 0.9em;">Redirecionando para a p√°gina inicial...</p>
                `;

                // Limpar formul√°rio
                form.reset();

                // Redirecionar ap√≥s 4 segundos
                setTimeout(() => {
                    window.location.href = 'index.html';
                }, 4000);

            } catch (error) {
                console.error('Erro no cadastro:', error);
                progressIndicator.classList.remove('show');
                formMessage.className = 'form-message error';
                
                let errorMessage = 'Erro ao processar cadastro. ';
                
                if (error.code === 'auth/email-already-in-use') {
                    errorMessage = 'Este e-mail j√° est√° cadastrado. Use outro e-mail ou fa√ßa login.';
                } else if (error.code === 'auth/invalid-email') {
                    errorMessage = 'E-mail inv√°lido. Verifique o endere√ßo de e-mail.';
                } else if (error.code === 'auth/weak-password') {
                    errorMessage = 'Senha muito fraca. Use no m√≠nimo 6 caracteres.';
                } else if (error.message) {
                    errorMessage += error.message;
                }
                
                formMessage.innerHTML = `<i class="fas fa-times-circle"></i> ${errorMessage}`;
            } finally {
                submitButton.disabled = false;
            }
        });
    </script>
</body>
</html>